---
meta:
 title: Setting up and using the pgaudit extension
 description: This page explains how to set up and use the pgaudit extension.
content:
 h1: Setting up and using the pgaudit extension
 paragraph: This page explains how to set up and use the pgaudit extension.
tags: managed-database postgresql pgaudit pg-extensions
dates:
 validation: 2024-03-05
 posted: 2024-03-05
categories:
 - managed-databases
 - postgresql-and-mysql
---


The `pgaudit` extension is available with Scaleway Managed Databases for PostgresSQL. The extension is a powerful monitoring and logging tool that allows you to keep track of the actions happening in your databases, and record them.


`pgaudit` allows you to log different statements executed in your Database Instance, or specific databases. You can keep track of who accessed your databases, what actions were performed, and when, under a [structured format](https://github.com/pgaudit/pgaudit/blob/master/README.md#format).


You can configure the extension to log only what is relevant to your audits.


## Requirements
- Be the [Owner](/identity-and-access-management/iam/concepts/#owner) of the Organization in which the actions will be performed, or an IAM user with the [necessary permissions](/identity-and-access-management/iam/concepts/#permission)
- A Scaleway account logged into the [console](https://console.scaleway.com)
- A [Database Instance](/managed-databases/postgresql-and-mysql/how-to/create-a-database) running a PostgreSQL engine


## Enabling and installing pgaudit

1. Click **PostgreSQL and MySQL** under **Managed Databases** on the side menu of the Scaleway console. A list of your Database Instances displays.
2. Click the Database Instance name or <Icon name="more" /> > **More info** to access the Instance information page.
3. Click the **Advanced settings** tab.
4. Click <Icon name="edit" />.
5. Click **+ Add parameters**.
6. Select `rdb.enable_pgaudit` in the drop-down and click the toggle to set it to `on`.
8. Click <Icon name="validate" /> to validate. Your Database Instance restarts.
   <Message type="important">
     Restarting can take up to a few dozen seconds depending on the size of your Database Instance.
   </Message>
9. [Connect to your Database Instance](/managed-databases/postgresql-and-mysql/how-to/connect-database-instance/).
10. Run the following command to install the `pgaudit` extension.
   ```
   CREATE EXTENSION pgaudit
   ```
   If the operation is successful, no output is returned.


## Configuring pgaudit


`pgaudit` provides two different types of logging:
   - **Session audit logging** - logs the operations, such as queries and updates, executed by a user during a session within a database or the entire Database Instance
   - **Object audit logging** - logs actions that involve specific data objects, like tables or files.


To use each one, you must configure the `pgaudit.log` and `pgaudit.role` settings, respectively.


Both settings can be set up at the Database Instance level, meaning that a global configuration can be applied to all databases within the Instance. You can configure them in the [advanced settings](/managed-databases/postgresql-and-mysql/concepts/#advanced-settings) of your Database Instance. You can use both settings concurrently.


`pgaudit.log` can also be configured for specific databases within your Instance.


### Setting up pgaudit.log


The `pgaudit.log` setting determines which classes of statements will be recorded through session audit logging.


The possible values include:


| Class        | Action         |
| ------------ | ------------------- |
| `READ`       | Logs `SELECT` and `COPY` commands when the source is a relation or a query. |
| `WRITE`      | Logs `INSERT`, `UPDATE`, `DELETE`, `TRUNCATE`, and `COPY` commands when the destination is a relation. |
| `FUNCTION`   | Logs function calls and `DO` blocks. |
| `ROLE`       | Logs statements related to roles and privileges, such as `GRANT`, `REVOKE`, `CREATE`, `ALTER`, and `DROP` `ROLE`.        |
| `DDL`        | Covers all Data Definition Language (DDL) statements not included in the ROLE class. |
| `MISC`       | Logs miscellaneous commands like `DISCARD`, `FETCH`, `CHECKPOINT`, `VACUUM`, `SET`.   |
| `MISC_SET`   | Logs miscellaneous `SET` commands. |
| `ALL`        | Includes all of the above classes for comprehensive logging. |


<Tabs id="pgauditlog">


 <TabsTab label="For a Database Instance">


   1. Go to the **Advanced settings** of your Database Instance in the Scaleway console.
   4. Click <Icon name="edit" />.
   5. Click **+ Add parameters**.
   6. Select `pgaudit.log` in the drop-down.
   7. Enter one or more of the statement class values listed above.
     <Message type="note">
       The values must be written in uppercase. If entering more than one class, separate them with a comma and no spaces. For example: `READ,WRITE`.
     </Message>
   8. Click <Icon name="validate" /> to validate.
     <Message type="note">
       The configuration takes a few seconds to be applied. During this time the Database Instance connection remains uninterrupted. However, you must wait the few seconds if you want to edit your advanced settings again.
     </Message>
   You can edit the `pgaudit.log` values in the advanced settings anytime.
 </TabsTab>


 <TabsTab label="For a specific database">


   1. [Connect to your database](/managed-databases/postgresql-and-mysql/how-to/connect-database-instance/) as an admin user.
   2. Run the following command to set `pgaudit.log` for the database. Replace `<database>` with the name of your database, and Â´<class>` with one or more of the statement class values listed above.
     ```
     database=> ALTER DATABASE <database> SET pgaudit.log = '<class>'
     ```
     If the operation is successful no output is returned.
   3. Reset the connection to your database to apply the configuration:
     ```
     database=> \q

     $ psql -h <ip-address> -p <port> -d <database-name> -U <username>
     ```
     <Message type="tip">
       Run `\drds` to see a list of your settings. You should get an output like the following:
       ```
                                      List of settings
        Role | Database |                   Settings
        ------+----------+----------------------------------------------
              | postgres | pgaudit.log=WRITE,FUNCTION,ROLE,DDL,MISC_SET
       ```
     </Message>

 </TabsTab>


</Tabs>


### Setting up pgaudit.role

Object audit logging is configured through the roles system. The `pgaudit.role` setting allows you to specify a principal audit role (also known as "master role").

An audit role refers to a role assigned to users or groups that grants them the authority to perform auditing tasks within a Database Instance. Assigning audit roles allows for the delegation of auditing responsibilities to different individuals or teams within an organization.

The primary function of the principal audit role is to oversee and manage the auditing process, including accessing audit logs and monitoring database activity.

Audit logging for an object (such as a `TABLE` or `VIEW`) takes place when the principal audit role has the necessary permissions to log the actions carried out on the object, or when it inherits these permissions from another role.

Currently, only the `SELECT`, `INSERT`, `UPDATE`, and `DELETE` permissions are supported.

  <Message type="note">
    There is no default principal role. You must create a new role, or specify an existing one as the principal audit.
  </Message>

To set up and grant permissions to the principal audit role follow these instructions:

1. [Connect to your database](/managed-databases/postgresql-and-mysql/how-to/connect-database-instance/) as an admin user.
2. Run the following command to create a new user. If no output is returned, the operation was successful.
    <Message type="note">
      If you want to specify an existing role as the principal audit, you can skip this step.
    </Message>

    ```
    CREATE ROLE auditor;
    ```
    You can replace `auditor` with your name of choice.

    <Message type="tip">
      Run `\du` to see a list of your database roles and check that the new role was created.
    </Message>
3. Set the role you created as `pgaudit.role`
    ```
    SET pgaudit.role = 'auditore';
    ```
    <Message type="note">
      Alternatively you can follow these steps to confiure `pgaudit.role` from the Scaleway console:

      1. Go to the **Advanced settings** of your Database Instance in the Scaleway console.
      2. Click <Icon name="edit" />.
      3. Click **+ Add parameters**.
      4. Select `pgaudit.role` in the drop-down and type the name of the role you created to be the principal.
      5. Click <Icon name="validate" /> to validate.
          <Message type="note">
            The configuration takes a few seconds to be applied. During this time the Database Instance connection remains uninterrupted. However, you must wait the few seconds if you want to edit your advanced settings again.
          </Message>
    </Message>
    You can edit the `pgaudit.role` values in the advanced settings anytime.
4. Run the following command in your Database Instance to grant the principal audit role permissions:
    ```
    GRANT PERMISSION1, PERMISSION2
      on <object>
      to <principal-role>;
    ```
    Replace `<PERMISSION1>` AND `<PERMISSION2>` with one or more of the supported permissions, `<object>` with the name of the data object you want to audit, and `auditor` with the `<principal-role>` with the name of the principal role.

If the operation was successful you see `GRANT` as an output.

## Accessing and handling logs

Your logs are accessible via the Scaleway Observability dashboard, [Cockpit]().

You can set up


Object renames are logged under the name they were renamed to. (https://github.com/pgaudit/pgaudit/blob/master/README.md#caveats)


### Optimizing disk usage

- Audit logs are flushed and consume disk space. The [log ingestion rate](https://www.scaleway.com/en/docs/observability/cockpit/reference-content/cockpit-limitations/#limits-for-loki) is **4MB per second**.

  To avoid log generation from exceeding ingestion, and the subsequent uncontrolled growth of disk usage, make sure you closely monitor the disk usage of the Database Instance. You can also update the `total_disk_retention` and `max_age_retention` attributes of the `log_policy` parameter to match your usage.

  <Message type="important">
    If the disk space becomes full, some audit logs may be lost.
  </Message>

- Before activating any audits, make sure you define exactly which statements are mandatory.

  Some statements might not be important for auditing use cases, such as `SELECT`. while generating high volume logs, taking up disk space. When it comes to SELECT and DML statements, we recommend opting for an object audit logging configuration rather than a session audit one. For more information: https://github.com/pgaudit/pgaudit?tab=readme-ov-file#usage-considerations


## Deactivating pgaudit

1. [Connect to your database](/managed-databases/postgresql-and-mysql/how-to/connect-database-instance/) as an admin user.
2. Run the following command to deactivate the `pgaudit` extension in your Database Instance.
    ```
    DROP EXTENSION pgaudit
    ```
3. Go to the **Advanced settings** of your Database Instance in the Scaleway console.
4. Click <Icon name="edit" />.
5. Click **+ Add parameters**.
6. Select `rdb.enable_pgaudit` in the drop-down and click the toggle to set it to `off`.
7. Click <Icon name="validate" /> to validate. Your Database Instance restarts.

<Message type="note">
  If you reactivate the extension, your previous configuration is applied.
</Message>


## Additional information
Logs are accessible via the standard PostgreSQL logging facility.
Logs format: https://github.com/pgaudit/pgaudit/blob/master/README.md#format
All management actions performed via API or console (e.g user/database creations and deletions) are logged, no matter the configuration. However the associated read statements are not logged (e.g select statements used to check that actions have been correctly executed).




## Set up examples
Audit logging on all statements for all databases and roles
Set pgaudit.log = 'all' in the Advanced settings




Audit logging only on DML statements for all databases and roles
Set pgaudit.log = 'write' in the Advanced settings




Audit logging on all statements, only on one database named 'mydb'
Set pgaudit.log = 'none' in the Advanced settings
Connect to your instance as an admin user and use this command: `ALTER DATABASE mydb SET pgaudit.log = 'all'`




Audit logging for all statements except read, write for all databases and roles & audit logging on select, insert, update, delete statements only on a specific table named 'mytable' in a database named 'mydb'
Set pgaudit.log = 'function,role,ddl,misc,misc_set' & pgaudit.role = 'auditor' in the Advanced settings
Connect to your instance as an admin user and use this command: 'GRANT select, insert, update, delete on mydb.mytable to auditor'
When creating a new master role used for object audit logging, we recommend first revoking all his privileges before granting specific audit privileges, for better fine-tuning.





