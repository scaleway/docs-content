---
title: How to periodically delete unused images in your container registry
description: Learn how to periodically delete unused images in your container registry.
categories:
  - serverless FaaS
  - containers
tags: compute serverless FaaS containers container-registry Python Urllib
image: /assets/scaleway_ceph.png
dates:
  validation: 2021-10-11
  posted: 2020-06-29
---

## Overview 

When overused, Registry can become really dense and store lots of unused images.
This tutorial will show you how to periodically remove older images with a specific tag using Serverless Functions, Scaleway Console and Pythonâ€™s Urllib.

<Message type="requirement">

 - You have an account and are logged into [the Scaleway console](https://console.scaleway.com) and have access to Registry and Functions
 - You have created a [Serverless Functions Namespace](/compute/container-registry/how-to/create-namespace/)  
 - You have generated [an API key](/console/my-project/how-to/generate-api-key)
</Message>


# Deleting unused images 


1. Log into the [the Scaleway console](https://console.scaleway.com).  

2. Click **Functions** in the **Compute** section of the side menu. The Functions page displays.

3. Click the Functions namespace you want to use to create your function.

4. Click **Create a Function**. The Function creation wizard displays.

5. Enter your function code.

6. From the first drop-down menu, choose to use the online code editor to edit your code directly from your browser in the box provided.

7. From the second drop-down menu, choose `python3` as your runtime. 

8. Delete what automatically displays in the online code editor. 

9. Type in the following code into the online code editor: 

````
import urllib.request
import os
import json
from datetime import datetime, timedelta
#Configuration

region=os.environ['REGION']
auth_token=os.environ['X-AUTH-TOKEN']
tags_to_keep=int(os.environ['TAGS-TO-KEEP']) # you can also use information passed to the event object

user_agent = 'Mozilla/5.0 (Windows NT 6.1; Win64; x64)'
headers={'X-Auth-Token':auth_token, 'User-Agent': user_agent}

def handle(event, context):
   images_list=[]
   browse=True
   i=1
  
   # Get the list of all images on all pages  
   while browse:
       url=f"https://api.scaleway.com/registry/v1/regions/{region}/images?page_size=100&order_by=created_at_asc&page="+str(i)
       req = urllib.request.Request(url, headers=headers)
       with urllib.request.urlopen(req) as response:
           res = response.read()
           img_list=eval(res)["images"]
       i=i+1
       if not img_list:
           browse=False
       else:
           images_list.extend(img_list)
   tags_to_delete=[]
  
   # Get all tags by image to delete
  
   for image in images_list:
       url=f"https://api.scaleway.com/registry/v1/regions/{region}/images/{image['id']}/tags?page_size=100&order_by=created_at_desc"
       req = urllib.request.Request(url, headers=headers)
       with urllib.request.urlopen(req) as response:
           res = response.read()
           tags=eval(res)["tags"]
       i=0
       for tag in tags:
           if i<tags_to_keep:
               i=i+1
           else:
               tags_to_delete.append(tag)
  
   #Delete tags and return their status
  
   msg=[]
   for tag in tags_to_delete:
       tag_id=tag['id']
       url_delete=f"https://api.scaleway.com/registry/v1/regions/{region}/tags/{tag_id}"
       req = urllib.request.Request(url_delete, headers=headers,method="DELETE")
       with urllib.request.urlopen(req) as response:
           res = response.read()
           msg.append(json.loads(res.decode("utf-8")))
  
   return {
       "body": {
           "message":msg
       },
       "statusCode": 200,
       }
```



Define a name
Choose a Memory plan
Define the following Environment variables
REGION: the Region in which your Registry is located
X-AUTH-TOKEN:Your Scaleway Token
TAGS-TO-KEEP: The number of Image tags you want to keep
Mark your function as Private
Add a CRON Job Triggers (in Advanced Option) to specify the frequency you want to execute the Function 
For example 0 2 * * * will make the Functions run everyday at 2 am
Deploy the function
You can run your function at any time by reaching its end point (Function Settings tab)

