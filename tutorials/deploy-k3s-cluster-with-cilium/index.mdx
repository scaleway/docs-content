---
meta:
  title: Creating a Kubernetes Cluster on Scaleway with K3s and Cilium
  description: This tutorial offers a detailed, step-by-step guide for setting up a Kubernetes cluster with K3s and Cilium on the Scaleway cloud platform.
content:
  h1: Creating a Kubernetes Cluster on Scaleway with K3s and Cilium
  paragraph: This tutorial offers a detailed, step-by-step guide for setting up a Kubernetes cluster with K3s and Cilium on the Scaleway cloud platform.
tags: kubernetes k3s cri containerd cni cilium
hero: 
categories: 
  - kubernetes
dates:
  validation: 2023-10-23
  posted: 2023-10-23
---

This step-by-step guide is designed to help you set up a highly efficient Kubernetes environment while minimizing costs and focusing on essential functionality. It caters to those seeking to enhance their understanding of Kubernetes and Cilium, helping them address the specific needs of budget-conscious users and IPv6 implementers.

<Macro id="iam-requirements" />

<Message type="requirement">
  - You have [installed and configured Scaleway CLI (v2)](https://github.com/scaleway/scaleway-cli)
  - You have [configured your SSH key](https://www.scaleway.com/en/docs/console/project/how-to/create-ssh-key/)
</Message>

## Choosing K3s and Cilium: A Lightweight and Efficient Kubernetes Setup
In this section, we'll explore the rationale behind our selection of K3s and Cilium as the core components of our Kubernetes cluster setup. We've chosen these technologies for their lightweight nature and their ability to deliver essential features efficiently.

1. K3s for Efficiency
[K3s](https://k3s.io/) is a lightweight, easy-to-install Kubernetes distribution designed for resource-constrained environments. It's an excellent choice for this tutorial because it simplifies the installation and management of Kubernetes without sacrificing functionality. K3s offers a reduced memory and CPU footprint, making it suitable for small to medium-scale setups like the one we're creating on Scaleway.

2. Cilium for Enhanced Networking and Security
[Cilium](https://cilium.io/) is a powerful Container Network Interface (CNI) plugin for Kubernetes. It's an ideal choice here because it enhances both security and performance. Cilium offers advanced networking and security features, including fine-grained network policies and efficient load balancing. This is particularly beneficial for those who want to leverage Kubernetes for their applications while maintaining a high level of security and performance, even in minimalist configurations.

In the pursuit of cost-efficient infrastructure, our Kubernetes cluster setup adopts an IPv6-only configuration to mitigate expenses associated with IPv4 address management.

## Setting Up Scaleway Infrastructure

In this section, we will walk you through the process of setting up the required infrastructure for your Kubernetes cluster.  

To begin, you need multiple virtual machines, each running a Linux-based operating system. We recommend using Ubuntu for its compatibility with K3S and Cilium. Follow these steps to create your virtual machines on Scaleway:

1. Set the environment variable to the zone where you want to deploy your cluster, `e.g. fr-par-2`

    ``` console
    $ export SCW_DEFAULT_ZONE=fr-par-2
    ```

2. Create an IPv6 routed IP address

    ```console
    $ scw instance ip create type=routed_ipv6
    ID            aa549e1d-15d5-4060-94da-0868a161bdef
    Organization  xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    Project       xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    Type          routed_ipv6
    State         detached
    Prefix        2001:bc8:1210:2fb::/64
    Zone          fr-par-2
    ```

3. Create the instance

    ``` console
    $ scw instance server create type=AMP2-C4 image=ubuntu-jammy routed-ip-enabled=true ip=none
    ID                          168ce790-29a9-4c06-b9b0-412efa240ba9
    Name                        cli-srv-friendly-mahavira
    AllowedActions.0            poweron
    AllowedActions.1            backup
    Tags.0                      k3s
    Tags.1                      master
    CommercialType              AMP2-C4
    CreationDate                1 second ago
    DynamicIPRequired           false
    RoutedIPEnabled             true
    EnableIPv6                  false
    Hostname                    cli-srv-friendly-mahavira
    ```

4. Attach the IPv6 address created in step 1 to the newly created instance

    ``` console
    $ scw instance ip attach 2001:bc8:1210:2fb:: server-id=168ce790-29a9-4c06-b9b0-412efa240ba9
    IP.ID            aa549e1d-15d5-4060-94da-0868a161bdef
    IP.Server.ID     168ce790-29a9-4c06-b9b0-412efa240ba9
    IP.Server.Name   cli-srv-friendly-mahavira
    IP.Type          routed_ipv6
    IP.State         pending
    IP.Prefix        2001:bc8:1210:2fb::/64
    IP.Zone          fr-par-2
    ```

5. Reiterate steps 2 to 4 to create 1 additional node

For the rest of the tutorial, node1 with ID 168ce790-29a9-4c06-b9b0-412efa240ba9 is considered as the server node and node2 with ID c0452ae7-b42f-4412-a4fe-833c11db36ae is considered the agent node.

## Installing K3s

In this section, we'll guide you through the process of installing K3s on your Scaleway virtual machines and setting up a Kubernetes cluster.

1. Due to GitHub's lack of IPv6 support, you'll need to fetch and save the K3s binary manually to the host. The K3s binary for each architecture can be found in the  [releases page](https://github.com/k3s-io/k3s/releases)and has to be uploaded in `/usr/local/bin` on each node. Then, ensure it is executable.

    ``` console
    $ wget https://github.com/k3s-io/k3s/releases/download/v1.28.2%2Bk3s1/k3s-arm64
    $ export node1=$(scw instance server get 168ce790-29a9-4c06-b9b0-412efa240ba9 | awk '$1 == "PublicIP.Address" {print $2}')
    $ scp -6 ./k3s-arm64 root@$node1:/usr/local/bin/k3s
    $ ssh root@$node1 chmod +x /usr/local/bin/k3s
    ```

2. From now on, you should SSH to the instance `ssh root@$node1` to execute the following commands on the remote host. First, you will install K3s and disable all unnecessary packaged components (Traefik, Metric Server, Helm Controller).

    ``` console
    $ export public_ip=$(ip -6 addr show dev enp0s1 scope global | awk '$1 == "inet6" {print substr($2, 1, length($2)-3)}')
    $ curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_EXEC="--flannel-backend=none --disable-network-policy --disable-kube-proxy --disable=traefik --disable=metrics-server --disable=local-storage --disable-helm-controller --cluster-cidr=2001:cafe:42:0::/56 --service-cidr=2001:cafe:42:1::/112 --node-ip=$public_ip" sh -
    ```

  You can check wthe K3s documentation to gather additional information on the available [packaged components](https://docs.k3s.io/installation/packaged-components)

3. Due to GitHub's lack of IPv6 support, you'll need to fetch and save the Cilium binary manually to the host. The K3s binary for each architecture can be found in the  [releases page](https://github.com/cilium/cilium-cli/releases)and has to be uploaded in `/usr/local/bin` on each node. Then, ensure it is executable. On your local machine, you should exectute the following instruction.

    ``` console
    $ CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
    $ CLI_ARCH=arm64
    $ curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
    $ sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
    $ scp -6 ./cilium-linux-${CLI_ARCH}.tar.gz root@$node1:/tmp    
    $ ssh root@$node1 tar xzvfC /tmp/cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
    $ ssh root@$node1 rm /tmp/cilium-linux-${CLI_ARCH}.tar.gz
    $ rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
    ```

4. You should now execture the following command in the remote host. As you will install Cilium with Gateway API support, you need to make sure the Gateway API CRDS are installed first. See the [Gateway API site](https://gateway-api.sigs.k8s.io/) for more details.

    ``` console
    $ export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    $ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.5.1/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
    $ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.5.1/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
    $ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.5.1/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
    $ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.5.1/config/crd/experimental/gateway.networking.k8s.io_referencegrants.yaml
    $ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
    ```

5. Then, install the Cilium plugin

    ``` console
    $ export node1=$(ip -6 addr show dev enp0s1 scope global | awk '$1 == "inet6" {print substr($2, 1, length($2)-3)}')
    $ cilium install --version 1.14.2 --namespace kube-system --set kubeProxyReplacement=true --set k8sServiceHost=${node1} --set k8sServicePort=6443 --set ingressController.enabled=true --set ingressController.loadbalancerMode=shared --set ingressController.default=true --set gatewayAPI.enabled=true --set ipv4.enabled=false --helm-set routingMode=native --helm-set ipv6NativeRoutingCIDR=2001:cafe:42:0::/56 --helm-set enableIPv6Masquerade=true --set ipv6.enabled=true
    ```

    To validate that Cilium has been properly installed, you can run `cilium status --wait`


      ``` console
      $ cilium status --wait
          /¯¯\
      /¯¯\__/¯¯\    Cilium:             OK
      \__/¯¯\__/    Operator:           OK
      /¯¯\__/¯¯\    Envoy DaemonSet:    disabled (using embedded mode)
      \__/¯¯\__/    Hubble Relay:       disabled
          \__/       ClusterMesh:        disabled

      DaemonSet              cilium             Desired: 1, Ready: 1/1, Available: 1/1
      Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
      Containers:            cilium             Running: 1
                            cilium-operator    Running: 1
      Cluster Pods:          2/2 managed by Cilium
      Helm chart version:    1.14.2
      Image versions         cilium             quay.io/cilium/cilium:v1.14.2@sha256:6263f3a3d5d63b267b538298dbeb5ae87da3efacf09a2c620446c873ba807d35: 1
                            cilium-operator    quay.io/cilium/operator-generic:v1.14.2@sha256:52f70250dea22e506959439a7c4ea31b10fe8375db62f5c27ab746e3a2af866d: 1
      ```

## Deploy your first application

1. On master node, create a manifest file to create the needed Kubernetes resources for our test application.

    ```
    # my-application.yaml
    kind: Deployment
    apiVersion: apps/v1
    metadata:
      name: whoami
      labels:
        app: whoami
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: whoami
      template:
        metadata:
          labels:
            app: whoami
        spec:
          containers:
            - name: whoami
              image: traefik/whoami
              ports:
                - name: web
                  containerPort: 80
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: whoami
    spec:
      ports:
        - name: web
          port: 80
          targetPort: web
      selector:
        app: whoami
    ---
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: whoami-ingress
    spec:
      rules:
      - http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: whoami
                port:
                  name: web
    ```

2. Apply the my-application.yml manifest to the cluster to deploy the test application.

    ``` console
    $ kubectl apply -f app.yml
    deployment.apps/whoami created
    service/whoami created
    ingress.networking.k8s.io/whoami-ingress created
    ```


3. Verify that your application is deployed and accessible on the internet `http://[2001:bc8:1210:2fb:dc00:ff:fe20:adef]/`

<Lightbox src="scaleway-validate-configuration.webp" size="medium" alt="" />

## Adding node to the Cluster (optional)

A single-node server installation is a fully-functional Kubernetes cluster. It is not necessary to add additional server or agents nodes, but you may want to do so to add additional capacity or redundancy to your cluster. To install additional agent nodes and add them to the cluster, run the installation script with the K3S_URL and K3S_TOKEN environment variables. Here is an example showing how to join an agent:

``` console
$ export node1=$(scw instance server get 168ce790-29a9-4c06-b9b0-412efa240ba9 | awk '$1 == "PublicIP.Address" {print $2}')
$ export node2=$(scw instance server get xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx | awk '$1 == "PublicIP.Address" {print $2}')
$ export K3S_TOKEN=$(ssh root@node1 cat /var/lib/rancher/k3s/server/node-token)
$ ssh root@node2 curl -sfL https://get.k3s.io | K3S_URL=https://${node1}:6443 K3S_TOKEN=${K3S_TOKEN} sh -
``

The K3s agent will register with the K3s server listening at the supplied URL. The value to use for `K3S_TOKEN` is stored at `/var/lib/rancher/k3s/server/node-token` on your server node (i.e., node1 in this example).

## Conclusion
In this tutorial, we embarked on a journey to create a highly efficient and cost-effective Kubernetes cluster on the Scaleway cloud platform. We started by laying the foundation, setting up an IPv6-only infrastructure, and replacing the traditional kube-proxy with Cilium for enhanced security and performance.

With K3s as our Kubernetes distribution, we streamlined the installation and configuration process, and by opting for minimalist components, we optimized our cluster for the essentials, all while keeping costs in check.

We hope this tutorial has empowered you with the knowledge and skills needed to create your own K3s Kubernetes cluster on Scaleway.

## Additional Resources
To continue your learning and exploration of Kubernetes, here are some valuable resources:
- [K3s Documentation](https://k3s.io/): The official documentation for K3s, providing in-depth information on installation, configuration, and advanced features.
- [Cilium Documentation](https://cilium.io/docs/): Explore the official documentation of the Cilium CNI plugin for Kubernetes, including detailed guides and use cases.
- [Kubernetes Documentation](https://kubernetes.io/docs/home/): The Kubernetes official documentation is a comprehensive resource for all things Kubernetes, from introductory concepts to advanced topics.
- [Scaleway Tutorials](https://www.scaleway.com/docs/tutorials/): Scaleway offers a collection of tutorials covering various topics, including cloud infrastructure and Kubernetes.

With these resources at your disposal, you'll be well-equipped to continue your Kubernetes journey, tackle more complex configurations, and adapt your cluster to meet evolving demands.





